/*
 * File generated by SourceCombiner.exe using 6 source files.
 * Created On: 10/11/2020 18:29:53
*/
using Microsoft.Build.Construction;
using Microsoft.Build.Evaluation;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
//*** SourceCombiner -> original file AutoMergeUtilities.cs ***
namespace AutoMergeTools
{
    class AutoMergeUtilities
    {
        private static readonly List<string> SourceFilesToIgnore = new List<string>
        {
            "AssemblyInfo.cs"
        };
        static public void MergeSourceFile(string projectFilePath, string outputFilePath)
        {
            var filesToParse = GetSourceFileNames(projectFilePath);
            var namespaces = GetUniqueNamespaces(filesToParse);
            string outputSource = GenerateCombinedSource(namespaces, filesToParse);
            File.WriteAllText(outputFilePath, outputSource);
        }
        private static string GenerateCombinedSource(List<string> namespaces, List<string> files)
        {
            StringBuilder sb = new StringBuilder();
            sb.AppendLine(@"/*");
            sb.AppendLine($" * File generated by SourceCombiner.exe using {files.Count} source files.");
            sb.AppendLine($" * Created On: {DateTime.Now}");
            sb.AppendLine(@"*/");
            foreach (var ns in namespaces.OrderBy(s => s))
            {
                sb.AppendLine("using " + ns + ";");
            }
            foreach (var file in files)
            {
                IEnumerable<string> sourceLines = File.ReadAllLines(file);
                sb.AppendLine(@"//*** SourceCombiner -> original file " + Path.GetFileName(file) + " ***");
                var openingTag = "using ";
                foreach (var sourceLine in sourceLines)
                {
                    var trimmedLine = sourceLine.Trim().Replace("  ", " ");
                    var isUsingDir = trimmedLine.StartsWith(openingTag) && trimmedLine.EndsWith(";");
                    if (!string.IsNullOrWhiteSpace(sourceLine) && !isUsingDir)
                    {
                        sb.AppendLine(sourceLine);
                    }
                }
            }
            return sb.ToString();
        }
        private static List<string> GetSourceFileNames(string solutionFilePath)
        {
            List<string> files = new List<string>();
            SolutionFile solutionFile = SolutionFile.Parse(solutionFilePath);
            foreach (Project project in solutionFile.ProjectsInOrder.Select(p => new Project(p.AbsolutePath)))
            {
                foreach (ProjectItem item in project.AllEvaluatedItems.Where(item => item.ItemType == "Compile"))
                {
                    if (!SourceFilesToIgnore.Contains(Path.GetFileName(item.EvaluatedInclude)))
                    {
                        string projectFolder = Path.GetDirectoryName(project.FullPath);
                        string fullpath = Path.Combine(projectFolder, item.EvaluatedInclude);
                        files.Add(fullpath);
                    }
                }
            }
            return files;
        }
        private static List<string> GetUniqueNamespaces(List<string> files)
        {
            var names = new List<string>();
            const string openingTag = "using ";
            const int namespaceStartIndex = 6;
            foreach (var file in files)
            {
                IEnumerable<string> sourceLines = File.ReadAllLines(file);
                foreach (var sourceLine in sourceLines)
                {
                    var trimmedLine = sourceLine.Trim().Replace("  ", " ");
                    if (trimmedLine.StartsWith(openingTag) && trimmedLine.EndsWith(";"))
                    {
                        var name = trimmedLine.Substring(namespaceStartIndex, trimmedLine.Length - namespaceStartIndex - 1);
                        if (!names.Contains(name))
                        {
                            names.Add(name);
                        }
                    }
                }
            }
            return names;
        }
    }
}
//*** SourceCombiner -> original file Form1.cs ***
namespace AutoMergeTools
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }
        private void buttonChooseSolution_Click(object sender, EventArgs e)
        {
            OpenFileDialog opf = new OpenFileDialog();
            if(opf.ShowDialog() == DialogResult.OK)
            {
                textBoxProject.Text = opf.FileName;
            }
        }
        private void buttonChooseOutputFile_Click(object sender, EventArgs e)
        {
            SaveFileDialog opf = new SaveFileDialog();
            if (opf.ShowDialog() == DialogResult.OK)
            {
                textBoxOutput.Text = opf.FileName;
            }
        }
        private void buttonProcessStart_Click(object sender, EventArgs e)
        {
            AutoMergeUtilities.MergeSourceFile(textBoxProject.Text,textBoxOutput.Text);
        }
    }
}
//*** SourceCombiner -> original file Form1.Designer.cs ***
namespace AutoMergeTools
{
    partial class Form1
    {
        /// <summary>
        /// Variable nécessaire au concepteur.
        /// </summary>
        private System.ComponentModel.IContainer components = null;
        /// <summary>
        /// Nettoyage des ressources utilisées.
        /// </summary>
        /// <param name="disposing">true si les ressources managées doivent être supprimées ; sinon, false.</param>
        protected override void Dispose(bool disposing)
        {
            if (disposing && (components != null))
            {
                components.Dispose();
            }
            base.Dispose(disposing);
        }
        #region Code généré par le Concepteur Windows Form
        /// <summary>
        /// Méthode requise pour la prise en charge du concepteur - ne modifiez pas
        /// le contenu de cette méthode avec l'éditeur de code.
        /// </summary>
        private void InitializeComponent()
        {
            this.buttonChooseSolution = new System.Windows.Forms.Button();
            this.buttonChooseOutputFile = new System.Windows.Forms.Button();
            this.textBoxProject = new System.Windows.Forms.TextBox();
            this.textBoxOutput = new System.Windows.Forms.TextBox();
            this.buttonProcessStart = new System.Windows.Forms.Button();
            this.label1 = new System.Windows.Forms.Label();
            this.label2 = new System.Windows.Forms.Label();
            this.SuspendLayout();
            // 
            // buttonChooseSolution
            // 
            this.buttonChooseSolution.Location = new System.Drawing.Point(565, 36);
            this.buttonChooseSolution.Name = "buttonChooseSolution";
            this.buttonChooseSolution.Size = new System.Drawing.Size(75, 23);
            this.buttonChooseSolution.TabIndex = 0;
            this.buttonChooseSolution.Text = "...";
            this.buttonChooseSolution.UseVisualStyleBackColor = true;
            this.buttonChooseSolution.Click += new System.EventHandler(this.buttonChooseSolution_Click);
            // 
            // buttonChooseOutputFile
            // 
            this.buttonChooseOutputFile.Location = new System.Drawing.Point(564, 87);
            this.buttonChooseOutputFile.Name = "buttonChooseOutputFile";
            this.buttonChooseOutputFile.Size = new System.Drawing.Size(75, 23);
            this.buttonChooseOutputFile.TabIndex = 1;
            this.buttonChooseOutputFile.Text = "...";
            this.buttonChooseOutputFile.UseVisualStyleBackColor = true;
            this.buttonChooseOutputFile.Click += new System.EventHandler(this.buttonChooseOutputFile_Click);
            // 
            // textBoxProject
            // 
            this.textBoxProject.Location = new System.Drawing.Point(13, 36);
            this.textBoxProject.Name = "textBoxProject";
            this.textBoxProject.Size = new System.Drawing.Size(546, 22);
            this.textBoxProject.TabIndex = 2;
            // 
            // textBoxOutput
            // 
            this.textBoxOutput.Location = new System.Drawing.Point(12, 87);
            this.textBoxOutput.Name = "textBoxOutput";
            this.textBoxOutput.Size = new System.Drawing.Size(546, 22);
            this.textBoxOutput.TabIndex = 2;
            // 
            // buttonProcessStart
            // 
            this.buttonProcessStart.Location = new System.Drawing.Point(510, 143);
            this.buttonProcessStart.Name = "buttonProcessStart";
            this.buttonProcessStart.Size = new System.Drawing.Size(130, 25);
            this.buttonProcessStart.TabIndex = 3;
            this.buttonProcessStart.Text = "Start Process";
            this.buttonProcessStart.UseVisualStyleBackColor = true;
            this.buttonProcessStart.Click += new System.EventHandler(this.buttonProcessStart_Click);
            // 
            // label1
            // 
            this.label1.AutoSize = true;
            this.label1.Location = new System.Drawing.Point(13, 13);
            this.label1.Name = "label1";
            this.label1.Size = new System.Drawing.Size(85, 17);
            this.label1.TabIndex = 4;
            this.label1.Text = "Solution File";
            // 
            // label2
            // 
            this.label2.AutoSize = true;
            this.label2.Location = new System.Drawing.Point(12, 67);
            this.label2.Name = "label2";
            this.label2.Size = new System.Drawing.Size(77, 17);
            this.label2.TabIndex = 4;
            this.label2.Text = "Output File";
            // 
            // Form1
            // 
            this.AutoScaleDimensions = new System.Drawing.SizeF(8F, 16F);
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
            this.ClientSize = new System.Drawing.Size(662, 181);
            this.Controls.Add(this.label2);
            this.Controls.Add(this.label1);
            this.Controls.Add(this.buttonProcessStart);
            this.Controls.Add(this.textBoxOutput);
            this.Controls.Add(this.textBoxProject);
            this.Controls.Add(this.buttonChooseOutputFile);
            this.Controls.Add(this.buttonChooseSolution);
            this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedToolWindow;
            this.Name = "Form1";
            this.Text = "Form1";
            this.ResumeLayout(false);
            this.PerformLayout();
        }
        #endregion
        private System.Windows.Forms.Button buttonChooseSolution;
        private System.Windows.Forms.Button buttonChooseOutputFile;
        private System.Windows.Forms.TextBox textBoxProject;
        private System.Windows.Forms.TextBox textBoxOutput;
        private System.Windows.Forms.Button buttonProcessStart;
        private System.Windows.Forms.Label label1;
        private System.Windows.Forms.Label label2;
    }
}
//*** SourceCombiner -> original file Program.cs ***
namespace AutoMergeTools
{
    static class Program
    {
        /// <summary>
        /// Point d'entrée principal de l'application.
        /// </summary>
        [STAThread]
        static void Main()
        {
            Application.EnableVisualStyles();
            Application.SetCompatibleTextRenderingDefault(false);
            Application.Run(new Form1());
        }
    }
}
//*** SourceCombiner -> original file Resources.Designer.cs ***
//------------------------------------------------------------------------------
// <auto-generated>
//     Ce code a été généré par un outil.
//     Version du runtime :4.0.30319.42000
//
//     Les modifications apportées à ce fichier peuvent provoquer un comportement incorrect et seront perdues si
//     le code est régénéré.
// </auto-generated>
//------------------------------------------------------------------------------
namespace AutoMergeTools.Properties {
    /// <summary>
    ///   Une classe de ressource fortement typée destinée, entre autres, à la consultation des chaînes localisées.
    /// </summary>
    // Cette classe a été générée automatiquement par la classe StronglyTypedResourceBuilder
    // à l'aide d'un outil, tel que ResGen ou Visual Studio.
    // Pour ajouter ou supprimer un membre, modifiez votre fichier .ResX, puis réexécutez ResGen
    // avec l'option /str ou régénérez votre projet VS.
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("System.Resources.Tools.StronglyTypedResourceBuilder", "16.0.0.0")]
    [global::System.Diagnostics.DebuggerNonUserCodeAttribute()]
    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
    internal class Resources {
        private static global::System.Resources.ResourceManager resourceMan;
        private static global::System.Globalization.CultureInfo resourceCulture;
        [global::System.Diagnostics.CodeAnalysis.SuppressMessageAttribute("Microsoft.Performance", "CA1811:AvoidUncalledPrivateCode")]
        internal Resources() {
        }
        /// <summary>
        ///   Retourne l'instance ResourceManager mise en cache utilisée par cette classe.
        /// </summary>
        [global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Advanced)]
        internal static global::System.Resources.ResourceManager ResourceManager {
            get {
                if (object.ReferenceEquals(resourceMan, null)) {
                    global::System.Resources.ResourceManager temp = new global::System.Resources.ResourceManager("AutoMergeTools.Properties.Resources", typeof(Resources).Assembly);
                    resourceMan = temp;
                }
                return resourceMan;
            }
        }
        /// <summary>
        ///   Remplace la propriété CurrentUICulture du thread actuel pour toutes
        ///   les recherches de ressources à l'aide de cette classe de ressource fortement typée.
        /// </summary>
        [global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Advanced)]
        internal static global::System.Globalization.CultureInfo Culture {
            get {
                return resourceCulture;
            }
            set {
                resourceCulture = value;
            }
        }
    }
}
//*** SourceCombiner -> original file Settings.Designer.cs ***
//------------------------------------------------------------------------------
// <auto-generated>
//     Ce code a été généré par un outil.
//     Version du runtime :4.0.30319.42000
//
//     Les modifications apportées à ce fichier peuvent provoquer un comportement incorrect et seront perdues si
//     le code est régénéré.
// </auto-generated>
//------------------------------------------------------------------------------
namespace AutoMergeTools.Properties {
    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator", "16.7.0.0")]
    internal sealed partial class Settings : global::System.Configuration.ApplicationSettingsBase {
        private static Settings defaultInstance = ((Settings)(global::System.Configuration.ApplicationSettingsBase.Synchronized(new Settings())));
        public static Settings Default {
            get {
                return defaultInstance;
            }
        }
    }
}
